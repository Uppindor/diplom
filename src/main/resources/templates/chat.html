<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
    <link rel="stylesheet" th:href="@{/css/css_chat.css}" />
    <style>
        .my-message {
            align-self: flex-end;
            background-color: #d1ecf1;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 5px;
            max-width: 60%;
            text-align: right;
        }

        .their-message {
            align-self: flex-start;
            background-color: #f8d7da;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 5px;
            max-width: 60%;
            text-align: left;
        }

        .my-message span.sender {
            display: block;
            font-size: 0.8rem;
            color: #0c5460;
            text-align: right;
        }

        .their-message span.sender {
            display: block;
            font-size: 0.8rem;
            color: #721c24;
            text-align: left;
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            padding: 20px;
            background-color: #f4f4f4;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .message-animate {
            opacity: 0;
            animation: fadeIn 1s forwards;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .time {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-left"></div>
    <div class="header-center">
        <a href="/profile" class="icon-btn" aria-label="–ü—Ä–æ—Ñ–∏–ª—å" role="button">
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
            <i data-lucide="user"></i>
        </a>
        <a th:href="@{'/chat/' + ${currentUsername}}" class="icon-btn" aria-label="–°–æ–æ–±—â–µ–Ω–∏—è" role="button">
            <span>–°–æ–æ–±—â–µ–Ω–∏—è</span>
            <i data-lucide="message-circle"></i>
        </a>
        <a href="/likes" class="icon-btn" role="button">
            <span>–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</span>
        </a>
        <a href="/setting" class="icon-btn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" role="button">
            <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            <i data-lucide="settings"></i>
        </a>
    </div>
    <div class="header-right"></div>
</div>

<div class="chat-card">
    <div class="chat-list" id="chatList">
        <h3>–í—Å–µ —á–∞—Ç—ã</h3>
    </div>

    <div class="chat-window">
        <h3 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button onclick="generateQuestion()" class="btn btn-info">–í–æ–ø—Ä–æ—Å</button>
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script th:inline="javascript">
    let currentUser = [[${currentUsername}]];
</script>

<script>
    let chats = {};
    let currentChat = null;
    let stompClient = null;
    let socket = null;

    function loadChatList() {
        fetch('/chats')
            .then(response => response.json())
            .then(data => {
                chats = data;
                renderChatList();
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error));
    }

    function renderChatList() {
        const chatList = document.getElementById("chatList");
        chatList.innerHTML = "<h3>–í—Å–µ —á–∞—Ç—ã</h3>";

        for (let username in chats) {
            const div = document.createElement("div");
            div.classList.add("chat-item");

            div.innerHTML = `
                <div class="chat-avatar"></div>
                <span class="chat-name">${username}</span>
                <span class="heart-btn" onclick="likeDislikeChat(event, '${username}')">&#9829;</span>
            `;

            div.onclick = () => openChat(username);
            chatList.appendChild(div);
        }
    }

    function openChat(username) {
        currentChat = username;
        const title = document.getElementById("chatTitle");
        title.textContent = "–ß–∞—Ç —Å " + username;

        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";

        chats[username].forEach(msg => {
            const p = document.createElement("p");
            p.classList.add("message-animate");
            const isMine = msg.sender === currentUser;
            p.classList.add(isMine ? "my-message" : "their-message");
            p.innerHTML = `<span class="sender">${msg.sender}</span>${msg.content}`;
            messagesDiv.appendChild(p);
        });
        scrollToBottom();
    }

    function sendMessage() {
        if (!currentChat) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç!");

        const input = document.getElementById("messageInput");
        const content = input.value.trim();
        if (!content) return;

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:mm
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const time = `${hours}:${minutes}`;

        const message = {
            sender: currentUser,
            recipient: currentChat,
            content: content,
            sentAt: time  // üëà –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ –æ–±—ä–µ–∫—Ç
        };

        const p = document.createElement("div");
        p.classList.add("message-animate", "my-message");
        p.innerHTML = `
            <span class="sender">${message.sender}</span>
            <div>${message.content}</div>
            <div class="time">${message.sentAt}</div>
        `;
        document.getElementById("messages").appendChild(p);
        scrollToBottom();

        if (!chats[currentChat]) {
            chats[currentChat] = [];
        }
        chats[currentChat].push(message);

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
        input.value = "";
    }


    function scrollToBottom() {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function likeDislikeChat(event, username) {
        const chatItem = event.target.closest(".chat-item");
        if (!chatItem) return;

        if (chatItem.classList.contains("liked")) {
            chatItem.classList.remove("liked");
            chatItem.classList.add("animate-left");
        } else {
            chatItem.classList.remove("disliked");
            chatItem.classList.add("liked");
            chatItem.classList.add("animate-right");
        }
        setTimeout(() => chatItem.classList.remove("animate-left", "animate-right"), 500);
    }

    function connect() {
        socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: " + frame);

            stompClient.subscribe("/user/queue/reply", function (messageOutput) {
                const chatMessage = JSON.parse(messageOutput.body);

                const partner = chatMessage.sender === currentUser ? chatMessage.recipient : chatMessage.sender;

                if (!chats[partner]) {
                    chats[partner] = [];
                }
                chats[partner].push(chatMessage);

                const isIncoming = chatMessage.sender !== currentUser && chatMessage.sender === currentChat;
                const isOutgoing = chatMessage.sender === currentUser && chatMessage.recipient === currentChat;

                if (isIncoming || isOutgoing) {
                    const p = document.createElement("p");
                    p.classList.add("message-animate");
                    const isMine = chatMessage.sender === currentUser;
                    p.classList.add(isMine ? "my-message" : "their-message");
                    p.innerHTML = `<span class="sender">${chatMessage.sender}</span>${chatMessage.content}`;
                    document.getElementById("messages").appendChild(p);
                    scrollToBottom();
                }
            });
        });
    }

    connect();
    loadChatList();
    lucide.createIcons();

    async function generateQuestion() {
    if (!currentChat) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç!");
        return;
    }

    const btn = document.querySelector('.btn-info');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
    btn.disabled = true;

    try {
        // 1. –ü–æ–ª—É—á–∞–µ–º matchId —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        const matchRes = await fetch(`/api/ask/match-id/${encodeURIComponent(currentChat)}`, {
            credentials: 'include' // –í–∞–∂–Ω–æ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∫—É–∫–æ–≤
        });

        if (!matchRes.ok) {
            const errorText = await matchRes.text();
            throw new Error(`HTTP ${matchRes.status}: ${errorText}`);
        }

        const matchData = await matchRes.json();
        console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ match:", matchData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

        if (!matchData?.matchId) {
            throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª ID –º–∞—Ç—á–∞ –≤ –æ–∂–∏–¥–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ");
        }

        // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å
        const questionRes = await fetch(`/api/ask/question/${matchData.matchId}`, {
            credentials: 'include'
        });

        if (!questionRes.ok) {
            const errorText = await questionRes.text();
            throw new Error(`HTTP ${questionRes.status}: ${errorText}`);
        }

        const questionData = await questionRes.json();
        console.log("–ü–æ–ª—É—á–µ–Ω –≤–æ–ø—Ä–æ—Å:", questionData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

        if (!questionData?.question) {
            throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –≤–æ–ø—Ä–æ—Å –≤ –æ–∂–∏–¥–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ");
        }

        // 3. –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç
        addAIMessage(questionData.question);

    } catch (error) {
        console.error("–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:", error);
        addAIMessage("–û—à–∏–±–∫–∞: " + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
function addAIMessage(content) {
    const messagesDiv = document.getElementById("messages");
    const messageDiv = document.createElement("div");
    messageDiv.className = "message-animate my-message";
    messageDiv.style.backgroundColor = "#17a2b8";
    messageDiv.innerHTML = `
        <span class="sender">AI Assistant</span>
        <div>${content}</div>
        <div class="time">${new Date().toLocaleTimeString()}</div>
    `;
    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
}

</script>
</body>
</html>
